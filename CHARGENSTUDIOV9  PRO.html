<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharGen Studio PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
        
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out; overflow: hidden; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
        .accordion-content.open { max-height: 2000px; opacity: 1; padding-top: 1rem; padding-bottom: 1rem;}
        
        .selected-item { background-color: #4f46e5 !important; color: #fff !important; font-weight: 600; }

        select, input, textarea {
            background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.5rem; width: 100%; padding: 0.5rem;
        }
        select:focus, input:focus, textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 2px #4f46e5; outline: none; }

        .loader {
            border: 4px solid #f3f4f6; border-top: 4px solid #6366f1; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        .small-loader { border-width: 3px; width: 18px; height: 18px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ai-suggestion-btn {
            padding: 0.3rem; margin-left: 0.5rem; background-color: #7c3aed; color: white;
            border-radius: 0.375rem; font-size: 0.75rem; line-height: 1; display: inline-flex; align-items: center;
        }
        .ai-suggestion-btn:hover { background-color: #6d28d9; }
        
        #sidebar { transition: transform 0.3s ease-in-out; }
        #rascunhoSidebar { transition: transform 0.3s ease-in-out; z-index: 60; }
        #openRascunhoBtn { z-index: 55; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        #openRascunhoBtn.hidden { opacity: 0; visibility: hidden; }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- Bot√£o e Sidebar de Rascunho -->
    <button id="openRascunhoBtn" class="fixed top-1/2 right-0 transform -translate-y-1/2 bg-violet-600 hover:bg-violet-700 text-white p-3 rounded-l-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
    </button>
    <div id="rascunhoSidebar" class="fixed top-0 right-0 h-full w-full sm:w-80 md:w-96 bg-slate-800 shadow-xl transform translate-x-full p-4 flex flex-col border-l border-slate-700">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-orbitron text-lg text-violet-300">Rascunho de Ideias</h3>
            <button id="closeRascunhoBtn" class="text-slate-300 hover:text-white p-1 rounded-md hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <textarea id="rascunhoTextarea" class="w-full flex-grow p-2 bg-slate-900 border-slate-700 rounded-md text-slate-200 text-sm mb-4 resize-none" placeholder="Digite ou gere ideias aqui..."></textarea>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
            <button id="addRascunhoToPromptBtn" class="flex-1 bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">Adicionar ao Prompt</button>
            <button id="clearRascunhoBtn" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">Limpar Rascunho</button>
        </div>
    </div>

    <!-- Header Principal -->
    <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
        <h1 class="font-orbitron text-2xl md:text-3xl font-bold text-violet-400">CharGen Studio <span class="text-violet-600">PRO</span></h1>
        <button id="hamburger-btn" class="p-2 rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-violet-500 md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
    </header>

    <div class="md:grid md:grid-cols-12 md:gap-8">
        
        <!-- Sidebar de Categorias -->
        <aside id="sidebar" class="md:col-span-4 lg:col-span-3 fixed md:relative top-0 left-0 h-full w-80 md:w-auto bg-slate-900 md:bg-transparent shadow-xl md:shadow-none transform -translate-x-full md:translate-x-0 z-40 p-4 md:p-0">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700 md:hidden">
                 <h2 class="font-orbitron text-xl text-violet-300">Categorias</h2>
                 <button id="close-sidebar-btn" class="p-2 rounded-md hover:bg-slate-700">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
            </div>
            <div class="h-full overflow-y-auto pr-2">
                 <form id="characterForm">
                     <div id="categories-container" class="space-y-2">
                         <!-- Categorias ser√£o inseridas aqui via JS -->
                     </div>
                 </form>
            </div>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="md:col-span-8 lg:col-span-9">
            
            <!-- Se√ß√£o de An√°lise por IA -->
            <div class="mb-6 bg-slate-800 rounded-lg shadow-xl p-4">
                <h2 class="font-orbitron text-xl text-violet-300 flex items-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-violet-400"><path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0S8.505 4.5 8.25 4.5m5.625 4.5H18a2.25 2.25 0 0 1 2.25 2.25v3.75a2.25 2.25 0 0 1-2.25 2.25H13.875m0 0A2.25 2.25 0 0 1 11.625 15h-1.5a2.25 2.25 0 0 1-2.25-2.25V8.625c0-.621.504-1.125 1.125-1.125h1.5a2.25 2.25 0 0 1 2.25 2.25Z" /></svg>
                    An√°lise com IA
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="imageUpload" class="block text-sm font-medium text-slate-300 mb-1">Upload de Imagem (PNG, JPG, WEBP - max 4MB)</label>
                        <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/webp" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-600 file:text-white hover:file:bg-violet-700 cursor-pointer">
                        <div id="imagePreviewContainer" class="mt-4 w-full h-48 bg-slate-700 rounded-lg flex items-center justify-center overflow-hidden mx-auto">
                            <img id="imagePreview" src="#" alt="Pr√©-visualiza√ß√£o da Imagem" class="hidden max-h-full max-w-full object-contain">
                            <span id="imagePreviewPlaceholder" class="text-slate-500">Pr√©-visualiza√ß√£o</span>
                        </div>
                        <button id="analyzeImageBtn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center text-sm">Analisar Imagem <div id="analyzeLoader" class="loader small-loader ml-3 hidden"></div></button>
                    </div>
                    <div>
                        <label for="analyzeTxtFileInput" class="block text-sm font-medium text-slate-300 mb-1">Upload de Texto (.txt)</label>
                        <input type="file" id="analyzeTxtFileInput" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-600 file:text-white hover:file:bg-violet-700 cursor-pointer">
                         <div class="mt-4 w-full h-48 bg-slate-700 rounded-lg flex items-center justify-center overflow-hidden mx-auto p-2">
                             <p class="text-slate-500 text-center text-sm">A IA pode analisar uma descri√ß√£o textual e preencher os campos do formul√°rio.</p>
                         </div>
                        <button id="analyzeTxtAndFillBtn" class="mt-2 w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center text-sm">Analisar Texto <div id="analyzeTxtLoader" class="loader small-loader ml-3 hidden"></div></button>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o do Prompt Final -->
            <div class="bg-slate-800/50 backdrop-blur-sm p-4 rounded-lg shadow-xl mb-6 sticky top-4 z-10">
                <label for="generatedPrompt" class="block text-sm font-medium text-slate-300 mb-2">Seu Prompt Final:</label>
                <textarea id="generatedPrompt" rows="8" class="w-full p-3 bg-slate-900 border-slate-700 rounded-lg text-slate-200 text-sm" placeholder="Selecione as op√ß√µes na barra lateral, use a IA para gerar detalhes e clique em 'Gerar Prompt'..."></textarea>
                <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                    <button id="generateCompactPromptBtn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-3 rounded-lg shadow-xl transition-transform hover:scale-105 text-sm">Gerar Compacto</button>
                    <button id="generateDetailedPromptBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shadow-xl transition-transform hover:scale-105 text-sm">Gerar Detalhado</button>
                    <button id="copyPromptBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Copiar</button>
                    <button id="randomizeAllBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Aleatorizar</button>
                    <button id="clearAllBtn" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Limpar</button>
                </div>
            </div>

            <!-- Se√ß√£o de Gera√ß√£o de Imagem -->
            <div class="p-6 bg-slate-800 rounded-lg shadow-xl mb-6">
                <h3 class="font-orbitron text-xl text-violet-300 mb-4 text-center">üñºÔ∏è Pr√©-visualiza√ß√£o da Imagem Gerada por IA</h3>
                <div class="flex flex-col items-center">
                    <button id="generateImagePreviewBtn" class="w-full md:w-2/3 bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-xl transition-transform hover:scale-105 mb-4 flex items-center justify-center">
                        Gerar Imagem do Personagem com IA
                        <div id="imageGenLoader" class="loader ml-3 hidden"></div>
                    </button>
                    <div id="generatedImageContainer" class="w-full md:w-96 h-96 bg-slate-700 rounded-lg flex items-center justify-center overflow-hidden">
                        <img id="generatedImagePreview" src="#" alt="Imagem Gerada pela IA" class="hidden max-h-full max-w-full object-contain">
                        <span id="generatedImagePlaceholder" class="text-slate-500">A imagem gerada aparecer√° aqui...</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-2 text-center">Utiliza o "Prompt Final" para gerar a imagem.</p>
                </div>
            </div>
            
            <!-- Se√ß√£o de Gerenciamento -->
            <div class="p-6 bg-slate-800 rounded-lg shadow-xl">
                 <h3 class="font-orbitron text-xl text-violet-300 mb-4 text-center">Gerenciamento</h3>
                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Salvar/Carregar</label>
                        <button id="saveCharacterTxtBtn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Salvar (.txt)</button>
                        <button id="loadCharacterBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Carregar (.txt)</button>
                        <input type="file" id="loadCharacterFileInput" class="hidden" accept=".txt">
                    </div>
                     <div>
                        <label for="presets" class="block text-sm font-medium text-slate-300 mb-1">Presets</label>
                        <select id="presets" name="presets" class="w-full p-2 mb-2"></select>
                        <button id="applyPresetBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Aplicar Preset</button>
                    </div>
                    <div class="flex flex-col space-y-2 justify-end sm:justify-start pt-0 sm:pt-7">
                       <label class="block text-sm font-medium text-slate-300 mb-1 invisible hidden sm:block">A√ß√µes</label>
                       <!-- Placeholder for alignment -->
                    </div>
                 </div>
            </div>

        </main>
    </div>

    <!-- Notifica√ß√£o Toast -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-violet-600 text-white py-3 px-6 rounded-lg shadow-xl text-sm z-50 transition-all duration-300 opacity-0 transform translate-y-10"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // State variables
        let openAccordion = null;
        let styleSelectedTerms = new Set();
        let toastTimeout;
        let base64ImageData = null;

        // Centralized data object for all form options
        const appData = {
            // Data from CHARGENSTUDIOV2 (more detailed)
            identidade: {
                genero: ["N√£o especificado", "Masculino", "Feminino", "N√£o-bin√°rio", "Andr√≥gino", "G√™nero-fluido", "Outro"],
                racaEspecie: {
                    "N√£o especificado": ["N√£o especificado"],
                    "Humanas": ["Humano (Caucasiano)", "Humano (Asi√°tico)", "Humano (Africano)", "Humano (Latino)", "Humano (Ind√≠gena)", "Humano (Miscigenado)"],
                    "Fantasia Cl√°ssica": ["Elfo (Alto Elfo)", "Elfo (Elfo da Floresta)", "Elfo (Elfo Negro/Drow)", "An√£o", "Orc", "Goblin", "Hobbit/Halfling", "Gnomo", "Tiefling", "Aasimar", "Draconato", "Homem-Fera (Lobisomem, Minotauro, etc.)"],
                    "Sci-Fi": ["Ciborgue", "Androide/Sint√©tico", "Alien√≠gena (Reptiliano)", "Alien√≠gena (Insetoide)", "Alien√≠gena (Humanoide)", "Alien√≠gena (Energ√©tico)", "Mutante"],
                    "Mitol√≥gicas": ["Anjo", "Dem√¥nio", "Vampiro", "Fada", "Sereia/Trit√£o", "Centauro", "Elemental"],
                    "Outras": ["Morto-vivo (Zumbi, Esqueleto)", "Construto (Golem)", "Planta Antropom√≥rfica"]
                },
                arquetipo: ["N√£o especificado", "O Her√≥i", "O Mentor", "O Guardi√£o", "O Arauto", "O Metamorfo", "A Sombra", "O Aliado", "O Trapaceiro", "A Donzela em Perigo", "O Vil√£o", "O Anti-Her√≥i"],
            },
            aparencia: {
                tipoCorpo: ["N√£o especificado", "Esguio", "Atl√©tico", "Musculoso(a)", "Corpulento(a)", "Magro(a)", "Curvil√≠neo(a)", "Robusto(a)", "Delicado(a)", "Infantil", "Idoso(a)"],
                texturaPele: ["N√£o especificado", "Lisa", "Escamosa", "Met√°lica", "Rochosa", "Peluda", "Transl√∫cida", "Brilhante", "Rachada", "Casca de √Årvore", "Queimada", "Cicatrizada"],
                penteado: {
                    "N√£o especificado": ["N√£o especificado"],
                    "Comprimentos": ["Careca", "Muito Curto (Raspado)", "Curto", "M√©dio (ombros)", "Longo", "Muito Longo (cintura ou mais)"],
                    "Estilos": ["Liso", "Ondulado", "Cacheado", "Crespo/Afro", "Tran√ßas", "Dreadlocks", "Rabo de Cavalo", "Coque", "Moicano", "Undercut", "Assim√©trico", "Bagun√ßado", "Com Franja"]
                },
            },
            trajes: {
                vestimentaPrincipal: ["N√£o especificado", "Roupas Casuais Modernas", "Traje Formal", "Uniforme", "Roupas de Aventura", "Vestes M√°gicas", "Traje Futurista", "Roupas Tribais"],
                armadura: {
                    "N√£o especificado": ["N√£o especificado", "Sem Armadura"],
                    "Leve": ["Couro Batido", "Corselete de Couro", "Gambeson/Acolchoada"],
                    "M√©dia": ["Cota de Malha", "Brigandina", "Peitoral de A√ßo", "Armadura de Escamas"],
                    "Pesada": ["Armadura de Placas Completa", "Armadura G√≥tica", "Armadura Samurai"],
                    "Sci-Fi": ["Exoesqueleto Leve", "Traje de Combate", "Armadura de Energia", "Nano-traje", "Power Armor"],
                    "Ex√≥tica": ["Armadura de Osso", "Armadura de Quitina", "Armadura de Cristal"]
                },
                armas: {
                    "N√£o especificado": ["N√£o especificado", "Desarmado(a)"],
                    "L√¢minas": ["Espada Longa", "Espada Curta", "Adaga", "Katana", "Cimitarra", "Rapieira"],
                    "Impacto": ["Ma√ßa", "Martelo de Guerra", "Clava", "Bast√£o"],
                    "Haste": ["Lan√ßa", "Alabarda", "Tridente"],
                    "Dist√¢ncia": ["Arco Longo", "Besta Pesada", "Facas de Arremesso"],
                    "Fogo/Sci-Fi": ["Pistola Flintlock", "Pistola Laser", "Rifle de Plasma"],
                    "M√°gicas": ["Cajado M√°gico", "Varinha", "Orbe", "Grim√≥rio"]
                }
            },
            narrativa: {
                temaGeral: ["N√£o especificado", "Aventura", "Batalha", "Explora√ß√£o", "Mist√©rio", "Sobreviv√™ncia", "Terror", "Romance", "Trag√©dia", "Com√©dia"],
                cenarioDetalhado: {
                    "N√£o especificado": ["N√£o especificado"],
                    "Natureza": ["Floresta Densa", "Montanhas Nevadas", "Deserto", "P√¢ntano", "Caverna de Cristais"],
                    "Urbano": ["Castelo Medieval", "Cidade Futurista", "Mercado Movimentado", "Viela Sombria"],
                    "Ex√≥tico": ["Cidade Flutuante", "Reino Subterr√¢neo", "Pal√°cio de Gelo", "Nave Espacial"]
                },
                acaoPose: {
                    "N√£o especificado": ["N√£o especificado", "Pose Neutra"],
                    "Est√°ticas": ["Sentado(a) em trono", "Meditando", "Observando o horizonte"],
                    "Din√¢micas": ["Correndo", "Saltando", "Brandindo arma", "Lan√ßando feiti√ßo"]
                },
                expressaoFacial: ["N√£o especificado", "Neutra", "Sorrindo", "Triste", "Irritado(a)", "Surpreso(a)", "Confiante", "Assustado(a)"],
            },
            // Data from CHARGENV8 (Style-based lists)
            styleLists: {
                artists: { title: "Artistas", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3 text-indigo-400"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M15.23 5.23L9.17 10.17c-.4.39-.4 1.02 0 1.41l5.3 5.3c.39.39 1.02.39 1.41 0l.71-.71c.39-.39.39-1.02 0-1.41L11.7 10.88l4.24-4.24c.39-.39.39-1.02 0-1.41l-.71-.71c-.39-.4-.08-1.03.31-1.42z"/></svg>`, items: ['Abigail Larson', 'Adam Hughes', 'Akira Toriyama', 'Alphonse Mucha', 'Anato Finnstark', 'Andreas Rocha', 'Ayami Kojima', 'Caspar David Friedrich', 'Frank Frazetta', 'Greg Rutkowski', 'H.R. Giger', 'Hayao Miyazaki', 'J.C. Leyendecker', 'James Jean', 'John Singer Sargent', 'Katsuhiro Otomo', 'Kim Jung Gi', 'Lois van Baarle (Loish)', 'Magali Villeneuve', 'Makoto Shinkai', 'Mike Mignola', 'Moebius', 'Seb McKinnon', 'Syd Mead', 'Yoshitaka Amano', 'Zdzis≈Çaw Beksi≈Ñski'] },
                media: { title: "M√≠dia/T√©cnica", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3 text-teal-400"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path></svg>`, items: ['aer√≥grafo', 'aquarela', 'arte digital', 'colagem', 'desenho com grafite', 'escultura', 'giz pastel', 'ilustra√ß√£o', '√≥leo sobre tela', 'pixel art', 'pintura acr√≠lica', 'tinta nanquim', 'xilogravura'] },
                aesthetics: { title: "Est√©tica", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3 text-yellow-400"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`, items: ['Academia Sombria', 'Afrofuturismo', 'Art D√©co', 'Art Nouveau', 'Biopunk', 'Cyberpunk', 'Dieselpunk', 'Distopia', 'Fantasia Sombria', 'Film Noir', 'G√≥tico', 'Minimalismo', 'P√≥s-apocal√≠ptico', 'Retrofuturismo', 'Solarpunk', 'Steampunk', 'Surrealismo', 'Vaporwave'] },
                acessorios: { title: "Acess√≥rios & Itens", icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-cyan-400"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.658-.463 1.243-1.119 1.243H5.502c-.656 0-1.19-.585-1.12-1.243l1.263-12a1.125 1.125 0 0 1 1.12-1.007h8.475a1.125 1.125 0 0 1 1.12 1.007Z" /></svg>`, items: ["Amuleto", "Anel M√°gico", "Bolsa de Cinto", "Cajado", "Capa com Capuz", "Chap√©u/Elmo", "Coroa/Tiara", "Luvas/Manoplas", "Mapa", "M√°scara", "Mochila", "√ìculos/Mon√≥culo", "Orbe de Cristal", "Varinha M√°gica"] },
                visuals: { title: "Efeitos Visuais", icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-pink-400"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672Zm-7.518-.267A8.25 8.25 0 1 1 20.25 10.5M8.288 14.212A5.25 5.25 0 1 1 17.25 10.5" /></svg>`, items: ["4K/8K", "Foco N√≠tido", "Ilumina√ß√£o de Est√∫dio", "Luz Volum√©trica", "Contraluz", "Ilumina√ß√£o Dram√°tica", "N√©voa/Neblina", "HDR", "Vazamento de Luz", "Lens Flare", "Gr√£o Cinematogr√°fico", "Bokeh", "Plano Detalhe", "Plano M√©dio", "Plano Inteiro", "√Çngulo Baixo (Contra-plong√©e)"] }
            }
        };
        const presets = {
            "guerreiraOrc": { nomePersonagem: "Grakka, a Esmagadora", racaEspecie: "Fantasia Cl√°ssica|Orc", genero: "Feminino", arquetipo: "O Her√≥i", tipoCorpo: "Musculoso(a)", corPele: "Verde-acinzentado", penteado: "Comprimentos|Longo", vestimentaPrincipal: "Roupas de Aventura", armadura: "Pesada|Armadura de Placas Completa", armas: "L√¢minas|Machado de Batalha", temaGeral: "Batalha", acaoPose: "Din√¢micas|Brandindo arma", expressaoFacial: "Irritado(a)", styleSelectedTerms: new Set(["Frank Frazetta", "Fantasia Sombria"])},
            "magaElfa": { nomePersonagem: "Lyra Noctu", racaEspecie: "Fantasia Cl√°ssica|Elfo (Elfo Negro/Drow)", genero: "Feminino", arquetipo: "O S√°bio", tipoCorpo: "Esguio", corPele: "Cinza obsidiana", corCabelo: "Branco-prateado", penteado: "Comprimentos|Muito Longo (cintura ou mais)", vestimentaPrincipal: "Vestes M√°gicas", armas: "M√°gicas|Cajado M√°gico", temaGeral: "Mist√©rio", cenarioDetalhado: "Natureza|Caverna de Cristais", acaoPose: "Din√¢micas|Lan√ßando feiti√ßo", expressaoFacial: "Concentrado(a)", styleSelectedTerms: new Set(["Yoshitaka Amano", "Abigail Larson", "G√≥tico", "Luz Volum√©trica"])},
            "ciborgueHacker": { nomePersonagem: "Zero", racaEspecie: "Sci-Fi|Ciborgue", genero: "N√£o-bin√°rio", arquetipo: "O Trapaceiro", tipoCorpo: "Atl√©tico", vestimentaPrincipal: "Traje Futurista", armadura: "Sci-Fi|Exoesqueleto Leve", armas: "Fogo/Sci-Fi|Pistola Laser", temaGeral: "Aventura", cenarioDetalhado: "Urbano|Cidade Futurista", acaoPose: "Est√°ticas|Observando o horizonte", expressaoFacial: "Confiante", styleSelectedTerms: new Set(["Syd Mead", "Cyberpunk", "Lens Flare", "4K/8K"]) }
        };

        // --- CORE FUNCTIONS ---

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            if(!toast) return;
            toast.textContent = message;
            toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl text-sm z-50 transition-all duration-300 opacity-0 transform translate-y-10';
            toast.classList.remove('opacity-0', 'translate-y-10');
            switch (type) {
                case 'success': toast.classList.add('bg-green-600'); break;
                case 'error': toast.classList.add('bg-red-600'); break;
                case 'warning': toast.classList.add('bg-amber-500'); break;
                default: toast.classList.add('bg-violet-600'); break;
            }
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function copyUsingExecCommand(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                if (document.execCommand('copy')) {
                    showToast('Copiado para a √°rea de transfer√™ncia!', 'success');
                } else {
                    showToast('Falha ao copiar (fallback).', 'error');
                }
            } catch (err) {
                showToast('Erro ao copiar (fallback).', 'error');
            }
            document.body.removeChild(textArea);
        }

        async function callGeminiAPI(promptText, loaderElement, buttonElement) {
            if (loaderElement) loaderElement.classList.remove('hidden');
            if (buttonElement) {
                 buttonElement.disabled = true;
                 buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            }
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: promptText }] }] };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro na API Gemini: ${response.statusText} - ${errorData?.error?.message || 'Detalhes n√£o dispon√≠veis'}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Resposta da API Gemini n√£o cont√©m dados esperados:", result);
                    showToast('A resposta da IA estava vazia ou malformada.', 'warning');
                    return null;
                }
            } catch (error) {
                console.error('Erro ao chamar API Gemini:', error);
                showToast(`Erro na IA: ${error.message}`, 'error');
                return null;
            } finally {
                if (loaderElement) loaderElement.classList.add('hidden');
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        
        async function callImagenAPI(promptText, loaderElement, buttonElement) {
            if (loaderElement) loaderElement.classList.remove('hidden');
            if (buttonElement) {
                 buttonElement.disabled = true;
                 buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            }
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { instances: [{ prompt: promptText }], parameters: { "sampleCount": 1 } };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro na API Imagen: ${response.statusText} - ${errorData?.error?.message || 'Detalhes n√£o dispon√≠veis'}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.warn("Resposta da API Imagen n√£o cont√©m dados esperados:", result);
                    showToast('A resposta da IA de imagem estava vazia.', 'warning');
                    return null;
                }
            } catch (error) {
                console.error('Erro ao gerar imagem com API Imagen:', error);
                showToast(`Erro na gera√ß√£o de imagem: ${error.message}`, 'error');
                return null;
            } finally {
                if (loaderElement) loaderElement.classList.add('hidden');
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // --- UI & FORM RENDERING FUNCTIONS ---

        function createAccordionButton(key, title, icon, type) {
            return `<div class="category-wrapper">
                        <button data-key="${key}" data-type="${type}" class="category-button w-full flex items-center justify-start p-3 bg-slate-800 rounded-lg shadow-md hover:bg-slate-700/50 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition-all duration-200 h-full">
                            ${icon} <span class="ml-3 text-sm font-semibold text-slate-300">${title}</span>
                        </button>
                        <div id="accordion-${key}" class="accordion-content bg-slate-800/50 rounded-b-lg px-4 -mt-1">
                        </div>
                    </div>`;
        }

        function createStyleAccordionContent(key, targetElement) {
            let itemsHTML = '';
            appData.styleLists[key].items.sort().forEach(item => {
                const isSelected = styleSelectedTerms.has(item) ? 'selected-item' : '';
                itemsHTML += `<a href="#" class="style-term-item block px-3 py-1.5 text-sm text-slate-200 hover:bg-violet-500/50 rounded-md ${isSelected}" data-term="${item}">${item}</a>`;
            });
            targetElement.innerHTML = `<div class="max-h-64 overflow-y-auto">${itemsHTML}</div>`;
        }

        function createFormAccordionContent(sectionId, targetElement) {
            const sectionsHTML = {
                identidade: `
                    <div class="space-y-4">
                        <div>
                            <label for="nomePersonagem" class="block text-xs font-medium text-slate-400 mb-1">Nome</label>
                            <div class="flex items-center">
                                <input type="text" id="nomePersonagem" name="nomePersonagem">
                                <button type="button" id="generateNameBtn" title="Gerar Nome com IA" class="ai-suggestion-btn">‚ú®<div id="nameLoader" class="loader small-loader ml-1 hidden"></div></button>
                            </div>
                        </div>
                        <div><label for="genero" class="block text-xs font-medium text-slate-400 mb-1">G√™nero</label><select id="genero" name="genero"></select></div>
                        <div><label for="racaEspecie" class="block text-xs font-medium text-slate-400 mb-1">Ra√ßa/Esp√©cie</label><select id="racaEspecie" name="racaEspecie"></select></div>
                        <div><label for="arquetipo" class="block text-xs font-medium text-slate-400 mb-1">Arqu√©tipo</label><select id="arquetipo" name="arquetipo"></select></div>
                    </div>`,
                aparencia: `
                    <div class="space-y-4">
                        <div><label for="tipoCorpo" class="block text-xs font-medium text-slate-400 mb-1">Tipo de Corpo</label><select id="tipoCorpo" name="tipoCorpo"></select></div>
                        <div><label for="texturaPele" class="block text-xs font-medium text-slate-400 mb-1">Textura da Pele</label><select id="texturaPele" name="texturaPele"></select></div>
                        <div><label for="penteado" class="block text-xs font-medium text-slate-400 mb-1">Penteado</label><select id="penteado" name="penteado"></select></div>
                        <div><label for="corPele" class="block text-xs font-medium text-slate-400 mb-1">Cor da Pele</label><input type="text" id="corPele" name="corPele"></div>
                        <div><label for="corCabelo" class="block text-xs font-medium text-slate-400 mb-1">Cor do Cabelo</label><input type="text" id="corCabelo" name="corCabelo"></div>
                        <div><label for="corOlhos" class="block text-xs font-medium text-slate-400 mb-1">Cor dos Olhos</label><input type="text" id="corOlhos" name="corOlhos"></div>
                    </div>`,
                trajes: `
                    <div class="space-y-4">
                        <div><label for="vestimentaPrincipal" class="block text-xs font-medium text-slate-400 mb-1">Vestimenta Principal</label><select id="vestimentaPrincipal" name="vestimentaPrincipal"></select></div>
                        <div><label for="armadura" class="block text-xs font-medium text-slate-400 mb-1">Armadura</label><select id="armadura" name="armadura"></select></div>
                        <div><label for="armas" class="block text-xs font-medium text-slate-400 mb-1">Arma</label><select id="armas" name="armas"></select></div>
                    </div>`,
                narrativa: `
                     <div class="space-y-4">
                        <div><label for="temaGeral" class="block text-xs font-medium text-slate-400 mb-1">Tema Geral</label><select id="temaGeral" name="temaGeral"></select></div>
                        <div><label for="cenarioDetalhado" class="block text-xs font-medium text-slate-400 mb-1">Cen√°rio</label><select id="cenarioDetalhado" name="cenarioDetalhado"></select></div>
                        <div><label for="acaoPose" class="block text-xs font-medium text-slate-400 mb-1">A√ß√£o/Pose</label><select id="acaoPose" name="acaoPose"></select></div>
                        <div><label for="expressaoFacial" class="block text-xs font-medium text-slate-400 mb-1">Express√£o Facial</label><select id="expressaoFacial" name="expressaoFacial"></select></div>
                    </div>`,
                desenvolvimento: `
                    <div class="space-y-4">
                        <div>
                            <label for="caracteristicasFisicas" class="block text-xs font-medium text-slate-400 mb-1">Caracter√≠sticas Essenciais</label>
                            <textarea id="caracteristicasFisicas" name="caracteristicasFisicas" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="historiaFundoGerada" class="block text-xs font-medium text-slate-400 mb-1">Hist√≥ria de Fundo</label>
                            <textarea id="historiaFundoGerada" name="historiaFundoGerada" rows="5"></textarea>
                            <button type="button" id="generateBackstoryBtn" class="mt-1 w-full text-xs bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-semibold py-1 px-2 rounded-lg flex items-center justify-center">Gerar Hist√≥ria <div id="backstoryLoader" class="loader small-loader ml-2 hidden"></div></button>
                        </div>
                        <div>
                            <label for="promptNegativo" class="block text-xs font-medium text-slate-400 mb-1">Prompt Negativo (Evitar)</label>
                            <input type="text" id="promptNegativo" name="promptNegativo" placeholder="deformado, texto, watermark...">
                        </div>
                    </div>`,
                default: `<p class="text-slate-400">Conte√∫do para a se√ß√£o '${sectionId}' em desenvolvimento.</p>`
            };
            targetElement.innerHTML = sectionsHTML[sectionId] || sectionsHTML.default;
        }

        function populateSelect(selectId, options, hasOptgroups = false) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            selectElement.innerHTML = ''; 
            if (hasOptgroups) {
                for (const groupLabel in options) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupLabel;
                    options[groupLabel].forEach(optionValue => {
                        const option = document.createElement('option');
                        option.value = `${groupLabel}|${optionValue}`;
                        option.textContent = optionValue;
                        optgroup.appendChild(option);
                    });
                    selectElement.appendChild(optgroup);
                }
            } else {
                options.forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    selectElement.appendChild(option);
                });
            }
        }
        
        function populateAllCharacterFields() {
             populateSelect('genero', appData.identidade.genero);
             populateSelect('racaEspecie', appData.identidade.racaEspecie, true);
             populateSelect('arquetipo', appData.identidade.arquetipo);
             populateSelect('tipoCorpo', appData.aparencia.tipoCorpo);
             populateSelect('penteado', appData.aparencia.penteado, true);
             populateSelect('texturaPele', appData.aparencia.texturaPele);
             populateSelect('vestimentaPrincipal', appData.trajes.vestimentaPrincipal);
             populateSelect('armadura', appData.trajes.armadura, true);
             populateSelect('armas', appData.trajes.armas, true);
             populateSelect('temaGeral', appData.narrativa.temaGeral);
             populateSelect('cenarioDetalhado', appData.narrativa.cenarioDetalhado, true);
             populateSelect('acaoPose', appData.narrativa.acaoPose, true);
             populateSelect('expressaoFacial', appData.narrativa.expressaoFacial);
             populateSelect('presets', Object.keys(presets).map(k => presets[k].nomePersonagem));
        }
        
        function toggleAccordion(key) {
            const accordion = document.getElementById(`accordion-${key}`);
            if (!accordion) return;
            const isVisible = accordion.classList.contains('open');
            if (openAccordion && openAccordion !== accordion) {
                openAccordion.classList.remove('open');
            }
            if (isVisible) {
                accordion.classList.remove('open');
                openAccordion = null;
            } else {
                accordion.classList.add('open');
                openAccordion = accordion;
            }
        }
        
        function renderAllCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            const allCategories = [
                // Formul√°rios
                { id: 'identidade', title: 'Identidade', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-violet-400"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`, type: 'form' },
                { id: 'aparencia', title: 'Apar√™ncia', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-sky-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.39m3.421 3.415a3 3 0 0 0 5.78-1.128 2.25 2.25 0 0 1 2.4-2.245 4.5 4.5 0 0 0-8.4 2.245c0 .399.078.78.22 1.128Zm0 0l3.388 1.62m-5.043-.025a15.994 15.994 0 0 1-1.622-3.39m3.421 3.415Z" /></svg>`, type: 'form' },
                { id: 'trajes', title: 'Trajes e Armas', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-rose-400"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.664 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.631 5.631L21.25 9.5l-5.208-5.209L9.5 11.042l5.63 5.63Z" /></svg>`, type: 'form' },
                { id: 'narrativa', title: 'Narrativa', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-3 text-amber-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`, type: 'form' },
                { id: 'desenvolvimento', title: 'Desenvolvimento', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-fuchsia-400"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" /></svg>`, type: 'form' },
                
                // Listas de Estilo (multi-sele√ß√£o)
                ...Object.keys(appData.styleLists).map(key => ({
                    id: key,
                    title: appData.styleLists[key].title,
                    icon: appData.styleLists[key].icon,
                    type: 'style'
                }))
            ];

            allCategories.forEach(cat => {
                container.innerHTML += createAccordionButton(cat.id, cat.title, cat.icon, cat.type);
            });

            allCategories.forEach(cat => {
                const accordionContent = document.getElementById(`accordion-${cat.id}`);
                if (cat.type === 'style') {
                    createStyleAccordionContent(cat.id, accordionContent);
                } else {
                    createFormAccordionContent(cat.id, accordionContent);
                }
            });

            populateAllCharacterFields();
        }

        // --- FEATURE FUNCTIONS (IA, File Handling, etc.) ---

        function setupImageAnalysis() {
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');
            const analyzeImageBtn = document.getElementById('analyzeImageBtn');
            const analyzeLoader = document.getElementById('analyzeLoader');

            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    base64ImageData = null;
                    return;
                }
                if (file.size > 4 * 1024 * 1024) { 
                    showToast('Erro: Imagem excede 4MB.', 'error');
                    imageUpload.value = ''; 
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePreviewPlaceholder.classList.add('hidden');
                    base64ImageData = e.target.result.split(',')[1]; 
                }
                reader.readAsDataURL(file);
            });

            analyzeImageBtn.addEventListener('click', async () => {
                if (!base64ImageData) {
                    showToast('Por favor, carregue uma imagem primeiro.', 'warning');
                    return;
                }
                
                const promptParaGemini = `Analise esta imagem de um personagem. Extraia as informa√ß√µes e formate a resposta com um marcador por linha (ex: "Cor da Pele: [valor]"). Campos para extrair: G√™nero Aparente, Tipo de Corpo, Cor dos Olhos, Cor do Cabelo, Penteado, Cor da Pele, Vestimenta Principal, Armadura, Acess√≥rios Vis√≠veis, Arma Principal, Pose, Express√£o Facial, Estilo Art√≠stico da Imagem, Cen√°rio Imediato, Descri√ß√£o Geral Detalhada. Se algo n√£o for vis√≠vel, omita o marcador.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: promptParaGemini }, { inlineData: { mimeType: imageUpload.files[0].type, data: base64ImageData } }] }]
                };

                // Re-using the generic API call function
                analyzeLoader.classList.remove('hidden');
                analyzeImageBtn.disabled = true;
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('API response not OK');
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        parseAndFillForm(text);
                        showToast('An√°lise da imagem conclu√≠da!', 'success');
                    } else {
                        throw new Error('No content in API response');
                    }
                } catch (error) {
                    showToast(`Erro na an√°lise de imagem: ${error.message}`, 'error');
                } finally {
                    analyzeLoader.classList.add('hidden');
                    analyzeImageBtn.disabled = false;
                }
            });
        }
        
        function setupTextAnalysis() {
            const fileInput = document.getElementById('analyzeTxtFileInput');
            const analyzeBtn = document.getElementById('analyzeTxtAndFillBtn');
            const loader = document.getElementById('analyzeTxtLoader');

            analyzeBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (event) => {
                 const file = event.target.files[0];
                 if (!file) return;

                 const reader = new FileReader();
                 reader.onload = async (e) => {
                    const fileContent = e.target.result;
                    if (!fileContent.trim()) {
                        showToast('O arquivo de texto est√° vazio.', 'warning');
                        return;
                    }
                    const promptParaGemini = `Analise a seguinte descri√ß√£o de personagem e extraia as informa√ß√µes para os campos do formul√°rio. Formate a resposta com um marcador por linha (ex: "Nome: [valor]"). Campos: Nome, G√™nero, Ra√ßa/Esp√©cie, Arqu√©tipo, Tipo de Corpo, Cor da Pele, Cor do Cabelo, Penteado, Cor dos Olhos, Vestimenta Principal, Armadura, Arma, A√ß√£o/Pose, Express√£o Facial, Cen√°rio, Tema, Caracter√≠sticas Essenciais. Texto: \n---\n${fileContent}`;
                    
                    const extractedText = await callGeminiAPI(promptParaGemini, loader, analyzeBtn);
                    if (extractedText) {
                        parseAndFillForm(extractedText);
                        showToast('Formul√°rio preenchido com base no texto!', 'success');
                    }
                 };
                 reader.readAsText(file);
                 event.target.value = ''; 
            });
        }

        function parseAndFillForm(apiResponseText) {
            const lines = apiResponseText.split('\n');
            const data = {};
            lines.forEach(line => {
                const parts = line.split(': ');
                if (parts.length > 1) {
                    data[parts[0].trim().toLowerCase()] = parts.slice(1).join(': ').trim();
                }
            });

            const fieldMappings = {
                'nome': 'nomePersonagem', 'g√™nero': 'genero', 'g√™nero aparente': 'genero', 'ra√ßa/esp√©cie': 'racaEspecie',
                'arqu√©tipo': 'arquetipo', 'tipo de corpo': 'tipoCorpo', 'cor da pele': 'corPele', 'cor do cabelo': 'corCabelo',
                'penteado': 'penteado', 'cor dos olhos': 'corOlhos', 'vestimenta principal': 'vestimentaPrincipal',
                'armadura': 'armadura', 'arma': 'armas', 'arma principal': 'armas', 'a√ß√£o/pose': 'acaoPose', 'pose': 'acaoPose', 'express√£o facial': 'expressaoFacial',
                'cen√°rio': 'cenarioDetalhado', 'cen√°rio imediato': 'cenarioDetalhado', 'tema': 'temaGeral', 'descri√ß√£o geral detalhada': 'caracteristicasFisicas',
                'caracter√≠sticas essenciais': 'caracteristicasFisicas', 'estilo art√≠stico da imagem': 'style'
            };

            for (const key in data) {
                const formFieldId = fieldMappings[key];
                if (formFieldId) {
                    if (formFieldId === 'style') {
                        const styles = data[key].split(',').map(s => s.trim());
                        styles.forEach(style => styleSelectedTerms.add(style));
                    } else {
                        const element = document.getElementById(formFieldId);
                        if (element) {
                            if (element.tagName === 'SELECT') {
                                const valueToFind = data[key];
                                let found = false;
                                for (let option of element.options) {
                                    if (option.textContent.toLowerCase().includes(valueToFind.toLowerCase())) {
                                        element.value = option.value;
                                        found = true;
                                        break;
                                    }
                                }
                            } else {
                                element.value = data[key];
                            }
                        }
                    }
                }
            }
            // Update UI for style terms
            document.querySelectorAll('.style-term-item').forEach(el => {
                 if (styleSelectedTerms.has(el.dataset.term)) {
                     el.classList.add('selected-item');
                 } else {
                     el.classList.remove('selected-item');
                 }
            });
            showToast('Campos preenchidos pela an√°lise da IA.', 'info');
        }

        async function generateCharacterName() {
            const raca = document.getElementById('racaEspecie').selectedOptions[0]?.textContent || "personagem";
            const genero = document.getElementById('genero').value !== "N√£o especificado" ? document.getElementById('genero').value : "";
            let promptText = `Sugira um nome criativo para um(a) ${raca} ${genero}. Forne√ßa apenas o nome.`;
            const nameText = await callGeminiAPI(promptText, document.getElementById('nameLoader'), document.getElementById('generateNameBtn'));
            if (nameText) {
                document.getElementById('nomePersonagem').value = nameText.trim();
                showToast('Nome gerado!', 'success');
            }
        }
        
        async function generateBackstory() {
             const context = getFormDataAsObject();
             let promptText = `Crie uma breve hist√≥ria (2-3 par√°grafos) para ${context.nomePersonagem || 'um personagem'}, um(a) ${context.racaEspecie || ''} ${context.arquetipo || ''}. Considere que a personalidade √© ${context.personalidade || 'desconhecida'} e o tema √© ${context.temaGeral || 'aventura'}.`;
             const backstoryText = await callGeminiAPI(promptText, document.getElementById('backstoryLoader'), document.getElementById('generateBackstoryBtn'));
             if(backstoryText) {
                 document.getElementById('historiaFundoGerada').value = backstoryText;
                 showToast('Hist√≥ria gerada!', 'success');
             }
        }

        async function generateImagePreview() {
            const promptText = document.getElementById('generatedPrompt').value;
            if (!promptText) {
                showToast('Gere um prompt primeiro.', 'warning');
                return;
            }

            const imageGenLoader = document.getElementById('imageGenLoader');
            const btn = document.getElementById('generateImagePreviewBtn');
            const imagePreviewEl = document.getElementById('generatedImagePreview');
            const imagePlaceholderEl = document.getElementById('generatedImagePlaceholder');

            imagePreviewEl.classList.add('hidden');
            imagePlaceholderEl.textContent = "Gerando imagem...";
            imagePlaceholderEl.classList.remove('hidden');

            const imageUrl = await callImagenAPI(promptText, imageGenLoader, btn);

            if (imageUrl) {
                imagePreviewEl.src = imageUrl;
                imagePreviewEl.classList.remove('hidden');
                imagePlaceholderEl.classList.add('hidden');
                showToast('Imagem gerada!', 'success');
            } else {
                imagePlaceholderEl.textContent = "Falha ao gerar imagem.";
            }
        }

        function getFormDataAsObject() {
            const data = {};
            const form = document.getElementById('characterForm');
            new FormData(form).forEach((value, key) => {
                if (value && value !== "N√£o especificado" && !value.endsWith("|N√£o especificado")) {
                   data[key] = value.includes('|') ? value.split('|')[1] : value;
                }
            });
            data.styleSelectedTerms = Array.from(styleSelectedTerms);
            return data;
        }

        function fillFormWithData(data) {
            clearAllFields(false);
            const form = document.getElementById('characterForm');
            for(const key in data){
                if (key === 'styleSelectedTerms') {
                    styleSelectedTerms = new Set(data[key]);
                } else if(form.elements[key]){
                     const element = form.elements[key];
                     if(element.tagName === 'SELECT'){
                         let found = false;
                         for(let opt of element.options){
                             const optText = opt.textContent;
                             const optVal = opt.value.includes('|') ? opt.value.split('|')[1] : opt.value;
                             if(optText === data[key] || optVal === data[key]){
                                element.value = opt.value;
                                found = true;
                                break;
                             }
                         }
                     } else {
                         element.value = data[key];
                     }
                }
            }
            document.querySelectorAll('.style-term-item').forEach(el => {
                el.classList.toggle('selected-item', styleSelectedTerms.has(el.dataset.term));
            });
        }

        function saveCharacterAsTxt() {
            const characterData = getFormDataAsObject();
            const characterName = characterData.nomePersonagem || 'personagem_chargen_pro';
            const filename = `${characterName.replace(/\s+/g, '_').toLowerCase()}.txt`;
            const dataStr = JSON.stringify(characterData, null, 2); 
            
            const blob = new Blob([dataStr], {type: "text/plain;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast(`Personagem salvo como ${filename}!`, 'success');
        }

        function loadCharacterFromTxt(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const characterData = JSON.parse(e.target.result); 
                    fillFormWithData(characterData);
                    showToast(`Personagem carregado!`, 'success');
                } catch (error) {
                    showToast('Erro ao carregar: Arquivo inv√°lido.', 'error');
                } finally {
                     event.target.value = ''; 
                }
            };
            reader.readAsText(file);
        }

        function applySelectedPreset() {
            const presetSelect = document.getElementById('presets');
            const presetName = presetSelect.options[presetSelect.selectedIndex].textContent;
            const presetKey = Object.keys(presets).find(k => presets[k].nomePersonagem === presetName);
            if (presetKey) {
                fillFormWithData(presets[presetKey]);
                showToast(`Preset "${presetName}" aplicado!`, 'success');
            }
        }
        
        function clearAllFields(notify = true) {
            document.getElementById('characterForm').reset();
            styleSelectedTerms.clear();
            document.querySelectorAll('.selected-item').forEach(el => el.classList.remove('selected-item'));
            document.getElementById('generatedPrompt').value = '';
            
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');
            imagePreview.classList.add('hidden');
            imagePreview.src = "#";
            imagePreviewPlaceholder.classList.remove('hidden');
            document.getElementById('imageUpload').value = ''; 
            base64ImageData = null;

            const generatedImagePreviewEl = document.getElementById('generatedImagePreview');
            const generatedImagePlaceholderEl = document.getElementById('generatedImagePlaceholder');
            generatedImagePreviewEl.classList.add('hidden');
            generatedImagePreviewEl.src = "#";
            generatedImagePlaceholderEl.textContent = "A imagem gerada aparecer√° aqui...";
            generatedImagePlaceholderEl.classList.remove('hidden');
            
            if (notify) showToast('Todos os campos foram limpos!', 'info');
        }

        function randomizeAllFields() {
            clearAllFields(false);
            const randomPresetKey = Object.keys(presets)[Math.floor(Math.random() * Object.keys(presets).length)];
            applySelectedPreset(randomPresetKey);
            showToast('Caracter√≠sticas aleat√≥rias aplicadas!', 'info');
        }
        
        function generatePrompt(type) {
            const formData = getFormDataAsObject();
            let compactParts = [];
            let detailedParts = [];

            // Add form fields
            for (const key in formData) {
                if (key !== 'styleSelectedTerms' && formData[key]) {
                    const value = formData[key];
                    compactParts.push(value);
                    const label = document.querySelector(`label[for="${key}"]`)?.textContent || key.charAt(0).toUpperCase() + key.slice(1);
                    detailedParts.push(`${label}: ${value}`);
                }
            }
            
            // Add style terms
            const styleString = formData.styleSelectedTerms.join(', ');
            if(styleString) {
                compactParts.unshift(styleString); // Add styles to the beginning
                detailedParts.push(`Estilos: ${styleString}`);
            }

            const rascunho = document.getElementById('rascunhoTextarea').value.trim();
            if (rascunho) {
                compactParts.push(rascunho);
                detailedParts.push(`Notas de Rascunho: ${rascunho}`);
            }
            
            const finalPrompt = type === 'detailed' ? detailedParts.join(". ") : compactParts.join(", ");
            document.getElementById('generatedPrompt').value = finalPrompt;
            if (finalPrompt) showToast(`Prompt ${type} gerado!`, 'success');
            else showToast('Nenhuma informa√ß√£o selecionada.', 'warning');
        }

        // --- INITIALIZATION ---
        function initializeUI() {
            // Render UI elements
            renderAllCategories();

            // Setup all event listeners
            document.getElementById('categories-container').addEventListener('click', (e) => {
                const button = e.target.closest('.category-button');
                if (button) {
                    e.preventDefault();
                    toggleAccordion(button.dataset.key);
                    // Attach AI button listeners if content is a form
                    if (button.dataset.type === 'form') {
                         if(document.getElementById('generateNameBtn')) document.getElementById('generateNameBtn').addEventListener('click', generateCharacterName);
                         if(document.getElementById('generateBackstoryBtn')) document.getElementById('generateBackstoryBtn').addEventListener('click', generateBackstory);
                    }
                }
                if (e.target.matches('.style-term-item')) {
                    e.preventDefault();
                    const term = e.target.dataset.term;
                    e.target.classList.toggle('selected-item');
                    if (styleSelectedTerms.has(term)) styleSelectedTerms.delete(term);
                    else styleSelectedTerms.add(term);
                }
            });

            // Main action buttons
            document.getElementById('generateCompactPromptBtn').addEventListener('click', () => generatePrompt('compacto'));
            document.getElementById('generateDetailedPromptBtn').addEventListener('click', () => generatePrompt('detalhado'));
            document.getElementById('copyPromptBtn').addEventListener('click', () => copyUsingExecCommand(document.getElementById('generatedPrompt').value));
            document.getElementById('randomizeAllBtn').addEventListener('click', randomizeAllFields);
            document.getElementById('clearAllBtn').addEventListener('click', () => clearAllFields(true));

            // Sidebar mobile controls
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sideMenu = document.getElementById('sidebar');
            const closeMenuBtn = document.getElementById('close-sidebar-btn');
            hamburgerBtn.addEventListener('click', () => sideMenu.classList.remove('-translate-x-full'));
            closeMenuBtn.addEventListener('click', () => sideMenu.classList.add('-translate-x-full'));

            // Feature setups
            setupImageAnalysis();
            setupTextAnalysis();
            document.getElementById('generateImagePreviewBtn').addEventListener('click', generateImagePreview);
            
            // Management buttons
            document.getElementById('saveCharacterTxtBtn').addEventListener('click', saveCharacterAsTxt);
            document.getElementById('loadCharacterBtn').addEventListener('click', () => document.getElementById('loadCharacterFileInput').click());
            document.getElementById('loadCharacterFileInput').addEventListener('change', loadCharacterFromTxt);
            document.getElementById('applyPresetBtn').addEventListener('click', applySelectedPreset);

            // Rascunho (Scratchpad) setup
            const openRascunhoBtn = document.getElementById('openRascunhoBtn');
            const closeRascunhoBtn = document.getElementById('closeRascunhoBtn');
            const rascunhoSidebar = document.getElementById('rascunhoSidebar');
            openRascunhoBtn.addEventListener('click', () => { rascunhoSidebar.classList.remove('translate-x-full'); openRascunhoBtn.classList.add('hidden'); });
            closeRascunhoBtn.addEventListener('click', () => { rascunhoSidebar.classList.add('translate-x-full'); openRascunhoBtn.classList.remove('hidden'); });
            document.getElementById('addRascunhoToPromptBtn').addEventListener('click', () => {
                const promptTextarea = document.getElementById('generatedPrompt');
                const rascunhoText = document.getElementById('rascunhoTextarea').value.trim();
                if(rascunhoText){
                    promptTextarea.value += (promptTextarea.value ? ', ' : '') + rascunhoText;
                    showToast('Rascunho adicionado!', 'success');
                }
            });
            document.getElementById('clearRascunhoBtn').addEventListener('click', () => {
                document.getElementById('rascunhoTextarea').value = '';
                showToast('Rascunho limpo.', 'info');
            });
        }
        
        initializeUI();
    });
    </script>
</body>
</html>
